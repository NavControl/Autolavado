<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Autolavado · Panel de Cliente{% endblock %}</title>

  {% block extra_css %}
  <!-- Bootstrap 5 utilidades de grilla -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome para iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/jquery-confirm.css') }}">
  <link rel="stylesheet" href="{{ url_for('admin.static', filename='css/styles.css') }}">
  {% endblock %}
</head>

<body>
  <!-- Barra superior -->
  <header class="topbar" role="banner">
    <div class="container-fluid topbar-inner">
      <div class="d-flex align-items-center gap-3">
        <button class="icon-btn d-md-none" aria-label="Abrir menú" id="openSidebar" aria-controls="sidebar"
          aria-expanded="false">
          <i class="fas fa-bars"></i>
        </button>
        <div class="brand">
          <div class="brand-logo" aria-hidden="true">🚗</div>
          <span class="brand-name">Autolavado</span>
        </div>
      </div>

<!-- En la sección del usuario, reemplaza con esto: -->
<div class="user">
  <div class="user-meta d-none d-sm-block">
    <div class="user-name" id="userName">
      {% if user_data and user_data.nombre_completo %}
        {{ user_data.nombre_completo }}
      {% else %}
        {{ user_nombre_completo }}
      {% endif %}
    </div>
    <div class="user-mail" id="userEmail">
      {% if user_data and user_data.email %}
        {{ user_data.email }}
      {% else %}
        {{ user_email }}
      {% endif %}
    </div>
  </div>
  <div class="avatar" aria-hidden="true">
    <i class="fas fa-user"></i>
  </div>
</div>
    </div>
  </header>

  <div class="layout">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar" role="navigation" aria-label="Menú principal">
      <nav class="nav-rail">
        <a class="nav-link {% if request.endpoint == 'client.cliente_inicio' %}active{% endif %}" 
           href="{{ url_for('client.cliente_inicio') }}"
           aria-current="{% if request.endpoint == 'client.cliente_inicio' %}page{% else %}false{% endif %}">
          <span class="nav-ico">
            <i class="fas fa-home"></i>
          </span>
          <span class="nav-txt">Dashboard</span>
        </a>
        
        <a class="nav-link {% if 'cita' in request.endpoint %}active{% endif %}" 
           href="{{ url_for('client.citas') }}">
          <span class="nav-ico">
            <svg width="18" height="18" viewBox="0 0 24 24">
              <path
                d="M7 2h10a2 2 0 0 1 2 2v2H5V4a2 2 0 0 1 2-2zm-2 6h14v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V8zm8 3h5v2h-5v-2z"
                fill="currentColor" />
            </svg>
          </span>
          <span class="nav-txt">Mis Citas</span>
        </a>
            
        <a class="nav-link {% if 'perfil' in request.endpoint %}active{% endif %}" 
           href="{{ url_for('client.perfil') }}">
          <span class="nav-ico">
            <svg width="18" height="18" viewBox="0 0 24 24">
              <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.33 0-8 2.17-8 5v1h16v-1c0-2.83-3.67-5-8-5z"
                fill="currentColor" />
            </svg>
          </span>
          <span class="nav-txt">Mi Perfil</span>
        </a>

        <a class="nav-link {% if 'vehiculos' in request.endpoint %}active{% endif %}" 
           href="{{ url_for('client.vehiculos') }}">
          <span class="nav-ico">
            <i class="fas fa-car"></i>
          </span>
          <span class="nav-txt">Mis Vehículos</span>
        </a>

        <a class="nav-link" href="{{ url_for('client.historial') }}">
          <span class="nav-ico">
            <i class="fas fa-history"></i>
          </span>
          <span class="nav-txt">Historial</span>
        </a>
        
        <div class="nav-sep" aria-hidden="true"></div>
        
        <a class="nav-link text-danger" href="{{ url_for('auth.salir') }}">
          <span class="nav-ico">
            <svg width="18" height="18" viewBox="0 0 24 24">
              <path d="M16 13v-2H7V8l-5 4 5 4v-3h9zM20 3h-8v2h8v14h-8v2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"
                fill="currentColor" />
            </svg>
          </span>
          <span class="nav-txt">Cerrar Sesión</span>
        </a>
      </nav>
    </aside>

    <!-- Contenido principal -->
    <main class="content" role="main">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show mb-4" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      
      {% block content %}{% endblock %}
    </main>
  </div>

  <!-- Scripts -->
  <script src="{{ url_for('static', filename='js/jquery-3.7.1.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/jquery-confirm.js') }}"></script>
  <script src="{{ url_for('static', filename='js/funciones.js') }}"></script>
  <script src="{{ url_for('admin.static', filename='js/admin.js') }}"></script>
  
  <script>
      // Función para actualizar la información del usuario en la barra superior
  function updateUserInfo() {
    // Intentar obtener información del usuario de diferentes fuentes
    const userNameElement = document.getElementById('userName');
    const userEmailElement = document.getElementById('userEmail');
    
    // Verificar si hay información en el formulario de perfil (si estamos en la página de perfil)
    const nombreInput = document.getElementById('nombre_completo');
    const emailInput = document.getElementById('correo');
    
    if (nombreInput && emailInput && nombreInput.value && emailInput.value) {
      userNameElement.textContent = nombreInput.value;
      userEmailElement.textContent = emailInput.value;
      
      // Guardar en sessionStorage para persistir entre páginas
      sessionStorage.setItem('user_nombre', nombreInput.value);
      sessionStorage.setItem('user_email', emailInput.value);
    }
    
    // Intentar cargar desde sessionStorage
    const savedNombre = sessionStorage.getItem('user_nombre');
    const savedEmail = sessionStorage.getItem('user_email');
    
    if (savedNombre && savedEmail) {
      userNameElement.textContent = savedNombre;
      userEmailElement.textContent = savedEmail;
    }
    
    console.log('Información del usuario actualizada:', {
      nombre: userNameElement.textContent,
      email: userEmailElement.textContent
    });
  }

  // Función para extraer información del perfil si está en la página
  function extractProfileInfo() {
    // Buscar elementos que contengan información del usuario en la página
    const profileElements = document.querySelectorAll('[class*="profile"], [id*="profile"], .card-body, .form-control');
    
    profileElements.forEach(element => {
      const text = element.textContent || element.value;
      if (text && text.includes('Ivan Segundo')) {
        const userNameElement = document.getElementById('userName');
        if (userNameElement && userNameElement.textContent === 'Cliente') {
          userNameElement.textContent = 'Ivan Segundo';
          sessionStorage.setItem('user_nombre', 'Ivan Segundo');
        }
      }
      if (text && text.includes('ivansegundomercado@gmail.com')) {
        const userEmailElement = document.getElementById('userEmail');
        if (userEmailElement && userEmailElement.textContent.includes('No autenticado')) {
          userEmailElement.textContent = 'ivansegundomercado@gmail.com';
          sessionStorage.setItem('user_email', 'ivansegundomercado@gmail.com');
        }
      }
    });
  }

  // Inicializar cuando el DOM esté listo
  document.addEventListener('DOMContentLoaded', function() {
    updateUserInfo();
    extractProfileInfo();
    
    // También actualizar después de que la página esté completamente cargada
    setTimeout(updateUserInfo, 1000);
    setTimeout(extractProfileInfo, 1000);
  });

  // Actualizar información cuando se cambia de página (para SPA-like behavior)
  document.addEventListener('click', function(e) {
    if (e.target.tagName === 'A' || e.target.closest('a')) {
      setTimeout(updateUserInfo, 500);
    }
  });

    // Toggle sidebar en móviles
    document.getElementById('openSidebar').addEventListener('click', function() {
      document.getElementById('sidebar').classList.toggle('open');
    });
    
    // Cerrar sidebar al hacer clic fuera de él en móviles
    document.addEventListener('click', function(event) {
      const sidebar = document.getElementById('sidebar');
      const openBtn = document.getElementById('openSidebar');
      
      if (window.innerWidth < 768 && 
          !sidebar.contains(event.target) && 
          !openBtn.contains(event.target) && 
          sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
      }
    });

    // Funcionalidad de búsqueda
    document.getElementById('searchForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const searchTerm = document.getElementById('q').value.trim();
      
      if (searchTerm) {
        performSearch(searchTerm);
      } else {
        showSearchAlert('Por favor, ingresa un término de búsqueda');
      }
    });

    function performSearch(term) {
      showSearchAlert('Buscando...', 'info');
      
      setTimeout(() => {
        showSearchAlert(`Búsqueda realizada: "${term}"`, 'success');
        displaySearchResults(term);
      }, 1000);
    }

    function displaySearchResults(term) {
      console.log('Mostrando resultados para:', term);
      
      const tables = document.querySelectorAll('table');
      tables.forEach(table => {
        const rows = table.querySelectorAll('tbody tr');
        let hasVisibleRows = false;
        
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          if (text.includes(term.toLowerCase())) {
            row.style.display = '';
            row.classList.add('highlight-search');
            hasVisibleRows = true;
          } else {
            row.style.display = 'none';
          }
        });

        // Mostrar mensaje si no hay resultados
        const tableContainer = table.closest('.table-responsive') || table.parentElement;
        let noResultsMsg = tableContainer.querySelector('.no-results-message');
        
        if (!hasVisibleRows) {
          if (!noResultsMsg) {
            noResultsMsg = document.createElement('div');
            noResultsMsg.className = 'no-results-message alert alert-info mt-3';
            noResultsMsg.textContent = `No se encontraron resultados para "${term}"`;
            tableContainer.appendChild(noResultsMsg);
          }
        } else if (noResultsMsg) {
          noResultsMsg.remove();
        }
      });
    }

    function showSearchAlert(message, type = 'warning') {
      const existingAlert = document.querySelector('.search-alert');
      if (existingAlert) {
        existingAlert.remove();
      }
      
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} alert-dismissible fade show search-alert mb-3`;
      alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      const mainContent = document.querySelector('main.content');
      if (mainContent && mainContent.querySelector('.alert') && !mainContent.querySelector('.search-alert')) {
        mainContent.insertBefore(alert, mainContent.querySelector('.alert').nextSibling);
      } else if (mainContent) {
        mainContent.insertBefore(alert, mainContent.firstChild);
      }
    }

    // Búsqueda en tiempo real (opcional)
    let searchTimeout;
    document.getElementById('q').addEventListener('input', function(e) {
      clearTimeout(searchTimeout);
      const term = e.target.value.trim();
      
      if (term.length >= 3) {
        searchTimeout = setTimeout(() => {
          performRealTimeSearch(term);
        }, 500);
      } else if (term.length === 0) {
        // Limpiar filtros si el campo está vacío
        clearSearchFilters();
      }
    });

    function performRealTimeSearch(term) {
      console.log('Búsqueda en tiempo real:', term);
      displaySearchResults(term);
    }

    function clearSearchFilters() {
      const tables = document.querySelectorAll('table');
      tables.forEach(table => {
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
          row.style.display = '';
          row.classList.remove('highlight-search');
        });
        
        const tableContainer = table.closest('.table-responsive') || table.parentElement;
        const noResultsMsg = tableContainer.querySelector('.no-results-message');
        if (noResultsMsg) {
          noResultsMsg.remove();
        }
      });
    }

    // Verificar información del usuario
    function checkUserInfo() {
      const userName = document.getElementById('userName');
      const userEmail = document.getElementById('userEmail');
      
      console.log('Información del usuario:', {
        nombre: userName.textContent.trim(),
        email: userEmail.textContent.trim()
      });
      
      // Si no está autenticado, podrías redirigir al login
      if (userEmail.textContent.includes('No autenticado')) {
        console.warn('Usuario no autenticado');
        // window.location.href = '/auth/login'; // Descomenta si quieres redirigir
      }
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
      checkUserInfo();
    });
  </script>
  
  <style>
    /* Estilos para el cuadro de búsqueda */
    .search-container {
      position: relative;
      display: flex;
      align-items: center;
      max-width: 400px;
    }
    
    .search-input {
      flex: 1;
      padding: 0.5rem 3rem 0.5rem 1rem;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      background-color: #fff;
      transition: all 0.2s ease;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #86b7fe;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .search-btn {
      position: absolute;
      right: 0.5rem;
      background: none;
      border: none;
      color: #6c757d;
      padding: 0.25rem;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    
    .search-btn:hover {
      color: #495057;
      background: none;
    }
    
    /* Estilos para resultados de búsqueda */
    .highlight-search {
      background-color: #fff3cd !important;
      border-left: 4px solid #ffc107;
      transition: all 0.3s ease;
    }
    
    .search-alert {
      margin-top: 1rem;
    }
    
    .no-results-message {
      text-align: center;
      padding: 1rem;
    }
    
    /* Asegurar que el layout se mantenga */
    .topbar-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1.5rem;
    }
    
    .brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .user {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .search-container {
        max-width: 200px;
      }
      
      .user-meta {
        display: none !important;
      }
    }
  </style>
  
  {% block extra_js %}{% endblock %}
</body>
</html>