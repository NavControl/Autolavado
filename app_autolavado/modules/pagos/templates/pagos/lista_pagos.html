{% extends 'admin/base.html' %}
{% block title %}Pagos Registrados{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="text-primary">
      <i class="fas fa-credit-card me-2"></i>Pagos Registrados
    </h4>
    <a href="{{ url_for('pagos_bp.registrar_pago') }}" class="btn btn-success">
      <i class="fas fa-plus"></i> Nuevo Pago
    </a>
  </div>

  {% if pagos %}
  <div class="card shadow-sm border-0">
    <div class="table-responsive">
      <table class="table table-striped align-middle mb-0">
        <thead class="table-primary">
          <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Servicio</th>
            <th>Método</th>
            <th>Monto</th>
            <th>Estado</th>
            <th>Referencia</th>
            <th>Fecha</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for p in pagos %}
          <tr>
            <td>{{ p.id_pago }}</td>
            <td>{{ p.cliente }}</td>
            <td>{{ p.servicio or '—' }}</td>
            <td>{{ p.metodo|capitalize }}</td>
            <td>${{ "%.2f"|format(p.monto) }}</td>
            <td>
              {% if p.estado == 'pagado' %}
                <span class="badge bg-success">Pagado</span>
              {% elif p.estado == 'pendiente' %}
                <span class="badge bg-warning text-dark">Pendiente</span>
              {% else %}
                <span class="badge bg-secondary">{{ p.estado }}</span>
              {% endif %}
            </td>
            <td>{{ p.codigo_referencia or '—' }}</td>
            <td>{{ p.fecha_pago or '-' }}</td>
            <td class="text-center">
              <!-- 👁️ Ver Detalle -->
              <a href="{{ url_for('pagos_bp.ver_pago', id_pago=p.id_pago) }}" 
                 class="btn btn-sm btn-outline-info" title="Ver Detalle">
                <i class="fas fa-eye"></i>
              </a>

              <!-- ✏️ Editar -->
              <a href="{{ url_for('pagos_bp.editar_pago', id_pago=p.id_pago) }}" 
                 class="btn btn-sm btn-outline-primary" title="Editar">
                <i class="fas fa-edit"></i>
              </a>

              <!-- 🗑️ Eliminar -->
              <form action="{{ url_for('pagos_bp.eliminar_pago', id_pago=p.id_pago) }}" 
                    method="POST" class="d-inline eliminar-form">
                <button type="submit" class="btn btn-sm btn-outline-danger" title="Eliminar">
                  <i class="fas fa-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <div class="alert alert-light text-center shadow-sm p-5">
    <i class="fas fa-info-circle fa-2x text-secondary mb-3"></i>
    <p class="text-muted mb-0">No hay pagos registrados aún.</p>
  </div>
  {% endif %}
</div>

<!-- 🧨 SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- ✅ Toast de mensajes Flash -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Mostrar mensajes Flash como toasts
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: '{{ "success" if category in ["success", "info"] else "error" }}',
          title: '{{ message }}',
          showConfirmButton: false,
          timer: 3000,
          timerProgressBar: true,
          background: '#f8f9fa',
          color: '#212529',
          iconColor: '{{ "green" if category == "success" else "red" }}'
        });
      {% endfor %}
    {% endif %}
  {% endwith %}

  // 🗑️ Confirmación antes de eliminar
  document.querySelectorAll('.eliminar-form').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      Swal.fire({
        title: '¿Eliminar este pago?',
        text: "Esta acción no se puede deshacer.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) form.submit();
      });
    });
  });
});
</script>
{% endblock %}
