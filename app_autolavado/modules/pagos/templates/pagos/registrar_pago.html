{% extends 'admin/base.html' %}
{% block title %}Registrar Pago{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm border-0">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Registrar Pago</h5>
    </div>

    <div class="card-body">
      <form method="POST" action="{{ url_for('pagos_bp.registrar_pago') }}" class="needs-validation" novalidate>
        <div class="row g-3">

          <!-- üîç Cliente con b√∫squeda din√°mica -->
          <div class="col-md-6 position-relative">
            <label for="buscarCliente" class="form-label fw-bold">Cliente</label>
            <input type="text" id="buscarCliente" class="form-control" placeholder="Buscar cliente..." autocomplete="off" required>
            <div id="listaClientes" class="list-group position-absolute w-100 shadow-sm" style="z-index: 1000;"></div>
            <input type="hidden" name="id_usuario" id="idClienteSeleccionado" required>
            <div class="invalid-feedback">Debe seleccionar un cliente v√°lido.</div>
          </div>

          <!-- Servicio -->
          <div class="col-md-6">
            <label for="id_reserva" class="form-label fw-bold">Servicio</label>
            <select class="form-select" id="id_reserva" name="id_reserva" required>
              <option value="">Seleccione un servicio...</option>
              {% for r in reservas %}
              <option value="{{ r.id_reserva }}">{{ r.nombre }}</option>
              {% endfor %}
            </select>
            <div class="invalid-feedback">Seleccione un servicio v√°lido.</div>
          </div>

          <!-- üí∞ Monto -->
          <div class="col-md-6">
            <label for="monto" class="form-label fw-bold">Monto ($MXN)</label>
            <input type="number" step="0.01" min="1" class="form-control" id="monto" name="monto" placeholder="Ej. 250.00" readonly required>
            <div class="invalid-feedback">El monto se asigna autom√°ticamente seg√∫n el servicio.</div>
          </div>

          <!-- M√©todo de pago -->
          <div class="col-md-6">
            <label for="metodo" class="form-label fw-bold">M√©todo de Pago</label>
            <select class="form-select" id="metodo" name="metodo" required>
              <option value="">Seleccione...</option>
              <option value="efectivo">Efectivo</option>
              <option value="paypal">PayPal</option>
            </select>
            <div class="invalid-feedback">Seleccione un m√©todo de pago.</div>
          </div>

          <!-- üí≥ C√≥digo de referencia PayPal -->
          <div class="col-md-6" id="refPaypal" style="display: none;">
            <label for="codigo_referencia" class="form-label fw-bold">C√≥digo de Referencia (PayPal)</label>
            <input type="text" class="form-control" name="codigo_referencia" id="codigo_referencia"
              placeholder="Ej. PAYPAL-1234XYZ" pattern="^[A-Za-z0-9\\-]{5,}$">
            <div class="invalid-feedback">Ingrese un c√≥digo de referencia v√°lido (m√≠nimo 5 caracteres).</div>
            <div id="alertaPaypal" class="mt-2 fw-bold"></div>
          </div>
        </div>

        <!-- Botones -->
        <div class="d-flex justify-content-end mt-4">
          <a href="{{ url_for('pagos_bp.lista_pagos') }}" class="btn btn-secondary me-2">
            <i class="fas fa-arrow-left me-1"></i>Cancelar
          </a>
          <button type="submit" class="btn btn-success" id="btnGuardar">
            <i class="fas fa-save me-1"></i>Guardar Pago
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
(() => {
  'use strict';
  const forms = document.querySelectorAll('.needs-validation');
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });
})();

document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("buscarCliente");
  const lista = document.getElementById("listaClientes");
  const idCliente = document.getElementById("idClienteSeleccionado");
  const metodo = document.getElementById("metodo");
  const refPaypal = document.getElementById("refPaypal");
  const inputCodigo = document.getElementById("codigo_referencia");
  const alertaPaypal = document.getElementById("alertaPaypal");
  const btnGuardar = document.getElementById("btnGuardar");
  const selectServicio = document.getElementById("id_reserva");
  const inputMonto = document.getElementById("monto");

  let precioServicio = 0;

  // =============================
  // üîç B√∫squeda din√°mica de cliente
  // =============================
  input.addEventListener("input", async () => {
    const q = input.value.trim();
    lista.innerHTML = "";
    idCliente.value = "";

    if (q.length < 2) return;

    const res = await fetch(`/admin/pagos/buscar_cliente?q=${encodeURIComponent(q)}`);
    const data = await res.json();

    if (data.length === 0) {
      lista.innerHTML = `<div class="list-group-item text-muted">Sin resultados</div>`;
      return;
    }

    data.forEach(cliente => {
      const item = document.createElement("a");
      item.href = "#";
      item.className = "list-group-item list-group-item-action";
      item.textContent = cliente.nombre;
      item.onclick = e => {
        e.preventDefault();
        input.value = cliente.nombre;
        idCliente.value = cliente.id;
        lista.innerHTML = "";
      };
      lista.appendChild(item);
    });
  });

  // ===========================
  // üí∞ Obtener precio del servicio
  // ===========================
  selectServicio.addEventListener("change", async () => {
    const id = selectServicio.value;
    inputMonto.value = "";
    precioServicio = 0;

    if (!id) return;

    try {
      const res = await fetch(`/admin/pagos/precio_servicio?id_reserva=${id}`);
      const data = await res.json();
      precioServicio = parseFloat(data.precio) || 0;
      inputMonto.value = precioServicio.toFixed(2);
    } catch (err) {
      console.error("Error al obtener precio:", err);
    }
  });

  // ===========================
  // üí≥ Mostrar campo PayPal
  // ===========================
  metodo.addEventListener("change", () => {
    if (metodo.value === "paypal") {
      refPaypal.style.display = "block";
      inputCodigo.setAttribute("required", "required");

      // ‚ö†Ô∏è Validar monto con el servicio
      if (parseFloat(inputMonto.value) !== precioServicio) {
        Swal.fire({
          icon: "error",
          title: "Monto incorrecto",
          text: "El monto debe coincidir con el precio del servicio seleccionado.",
        });
        btnGuardar.disabled = true;
      } else {
        btnGuardar.disabled = false;
      }

    } else {
      refPaypal.style.display = "none";
      inputCodigo.removeAttribute("required");
      inputCodigo.value = "";
      alertaPaypal.textContent = "";
      alertaPaypal.className = "mt-2 fw-bold";
      btnGuardar.disabled = false;
    }
  });

  // ==========================================
  // ‚ö° Validar c√≥digo PayPal (AJAX)
  // ==========================================
  inputCodigo.addEventListener("blur", async () => {
    const codigo = inputCodigo.value.trim();
    alertaPaypal.textContent = "";
    alertaPaypal.className = "mt-2 fw-bold";

    if (!codigo) {
      btnGuardar.disabled = false;
      return;
    }

    try {
      const res = await fetch(`/admin/pagos/validar_codigo_paypal?codigo=${encodeURIComponent(codigo)}`);
      const data = await res.json();

      if (!data.valido) {
        inputCodigo.classList.add("is-invalid");
        inputCodigo.classList.remove("is-valid");
        alertaPaypal.textContent = data.mensaje;
        alertaPaypal.classList.add("text-danger");
        btnGuardar.disabled = true;
      } else {
        inputCodigo.classList.remove("is-invalid");
        inputCodigo.classList.add("is-valid");
        alertaPaypal.textContent = data.mensaje;
        alertaPaypal.classList.add("text-success");
        btnGuardar.disabled = false;
      }
    } catch (err) {
      console.error("Error al validar el c√≥digo:", err);
    }
  });
});
</script>
{% endblock %}
