{% extends 'admin/base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fa fa-plus-circle me-2"></i>Crear Nuevo Paquete</h2>
        <a href="/services/paquetes" class="btn-modern btn-modern-primary">
            <i class="fa fa-arrow-left me-2"></i>Volver a Paquetes
        </a>
    </div>

    <div class="row">
        <!-- Formulario del Paquete -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Informaci贸n del Paquete</h5>
                </div>
                <div class="card-body">
                    <form id="formPaquete">
                        <div class="mb-3">
                            <label for="nombrePaquete" class="form-label">Nombre del Paquete</label>
                            <input type="text" class="form-control" id="nombrePaquete" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="descripcionPaquete" class="form-label">Descripci贸n</label>
                            <textarea class="form-control" id="descripcionPaquete" rows="3"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="precioPaquete" class="form-label">Precio del Paquete ($)</label>
                            <input type="number" step="0.01" class="form-control" id="precioPaquete" required>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Servicios seleccionados:</span>
                                <span id="contadorServicios" class="badge bg-primary">0</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Duraci贸n total:</span>
                                <span id="duracionTotal" class="badge bg-info">0 min</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Precio individual:</span>
                                <span id="precioIndividual" class="badge bg-secondary">$0.00</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span><strong>Ahorro:</strong></span>
                                <span id="ahorro" class="badge bg-success">$0.00</span>
                            </div>
                        </div>
                        
                        <button type="button" class="btn-modern btn-modern-success" onclick="crearPaquete()">
                            <i class="fa fa-save me-2"></i>Crear Paquete
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Lista de Servicios Disponibles -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Selecciona los Servicios para el Paquete</h5>
                </div>
                <div class="card-body">
                    {% if servicios %}
                    <div class="row" id="listaServicios">
                        {% for servicio in servicios %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card servicio-card h-100" data-servicio-id="{{ servicio.id_servicio }}">
                                <div class="card-body">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input servicio-checkbox" 
                                               type="checkbox" 
                                               value="{{ servicio.id_servicio }}"
                                               id="servicio{{ servicio.id_servicio }}"
                                               data-precio="{{ servicio.precio }}"
                                               data-duracion="{{ servicio.duracion }}"
                                               onchange="actualizarResumen()">
                                        <label class="form-check-label fw-bold" for="servicio{{ servicio.id_servicio }}">
                                            {{ servicio.nombre }}
                                        </label>
                                    </div>
                                    <p class="card-text small text-muted mb-2">{{ servicio.descripcion or 'Sin descripci贸n' }}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-success fw-bold">${{ servicio.precio }}</span>
                                        <span class="text-muted small">{{ servicio.duracion }} min</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fa fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                        <p class="text-muted">No hay servicios disponibles para crear paquetes.</p>
                        <a href="/services/agregar-servicio" class="btn-modern btn-modern-success">
                            <i class="fa fa-plus me-2"></i>Crear Primer Servicio
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let serviciosSeleccionados = [];

function actualizarResumen() {
    const checkboxes = document.querySelectorAll('.servicio-checkbox:checked');
    serviciosSeleccionados = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    // Calcular totales
    let precioTotal = 0;
    let duracionTotal = 0;
    
    checkboxes.forEach(cb => {
        precioTotal += parseFloat(cb.dataset.precio);
        duracionTotal += parseInt(cb.dataset.duracion);
    });
    
    // Actualizar UI
    document.getElementById('contadorServicios').textContent = serviciosSeleccionados.length;
    document.getElementById('duracionTotal').textContent = duracionTotal + ' min';
    document.getElementById('precioIndividual').textContent = '$' + precioTotal.toFixed(2);
    
    // Calcular ahorro cuando se ingresa el precio del paquete
    const precioPaquete = parseFloat(document.getElementById('precioPaquete').value) || 0;
    const ahorro = precioTotal - precioPaquete;
    document.getElementById('ahorro').textContent = '$' + ahorro.toFixed(2);
    
    if (ahorro > 0) {
        document.getElementById('ahorro').className = 'badge bg-success';
    } else if (ahorro < 0) {
        document.getElementById('ahorro').className = 'badge bg-danger';
    } else {
        document.getElementById('ahorro').className = 'badge bg-secondary';
    }
}

async function crearPaquete() {
    const nombre = document.getElementById('nombrePaquete').value;
    const descripcion = document.getElementById('descripcionPaquete').value;
    const precio = document.getElementById('precioPaquete').value;
    
    if (!nombre || !precio) {
        alert('Por favor, completa el nombre y precio del paquete');
        return;
    }
    
    if (serviciosSeleccionados.length === 0) {
        alert('Selecciona al menos un servicio para el paquete');
        return;
    }
    
    try {
        const response = await fetch('/services/procesar-paquete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                nombre: nombre,
                descripcion: descripcion,
                precio: parseFloat(precio),
                servicios: serviciosSeleccionados
            })
        });
        
        const data = await response.json();
        
        if (data.message === "OK") {
            alert('Paquete creado correctamente');
            window.location.href = '/services/paquetes';
        } else {
            alert('Error al crear el paquete: ' + (data.error || ''));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al crear el paquete');
    }
}

// Actualizar ahorro cuando cambia el precio del paquete
document.getElementById('precioPaquete').addEventListener('input', actualizarResumen);
</script>

<style>
.servicio-card {
    transition: all 0.3s;
    cursor: pointer;
}
.servicio-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.servicio-checkbox:checked + label {
    color: #198754;
    font-weight: bold;
}

.btn-modern {
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    border: 1px solid;
    cursor: pointer;
}


    
.btn-modern-primary {
    background: var(--bs-primary);
    border-color: var(--bs-primary);
    color: var(--bs-white);
}
    
.btn-modern-primary:hover {
    background: var(--bs-primary-dark);
    border-color: var(--bs-primary-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(var(--bs-primary-rgb), 0.3);
    color: var(--bs-primary-dark);
}
</style>
{% endblock %}