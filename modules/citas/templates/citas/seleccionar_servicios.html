{% extends 'admin/base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fa fa-list me-2"></i>Seleccionar Servicios
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Steps -->
                    <div class="steps mb-5">
                        <div class="step completed">
                            <div class="step-number">1</div>
                            <div class="step-label">Inicio</div>
                        </div>
                        <div class="step active">
                            <div class="step-number">2</div>
                            <div class="step-label">Servicios</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-label">Fecha y Hora</div>
                        </div>
                        <div class="step">
                            <div class="step-number">4</div>
                            <div class="step-label">Vehículo</div>
                        </div>
                        <div class="step">
                            <div class="step-number">5</div>
                            <div class="step-label">Confirmar</div>
                        </div>
                    </div>

                    <!-- Servicios Individuales -->
                    <div class="mb-5">
                        <h5 class="mb-3">Servicios Individuales</h5>
                        <div class="row" id="servicios-container">
                            {% for servicio in servicios %}
                            <div class="col-md-6 mb-3">
                                <div class="card servicio-card h-100" data-id="{{ servicio.id_servicio }}" data-tipo="servicio" data-precio="{{ servicio.precio }}" data-duracion="{{ servicio.duracion }}">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input servicio-checkbox" type="checkbox" 
                                                   id="servicio-{{ servicio.id_servicio }}">
                                            <label class="form-check-label w-100" for="servicio-{{ servicio.id_servicio }}">
                                                <h6 class="card-title">{{ servicio.nombre }}</h6>
                                                <p class="card-text text-muted small">{{ servicio.descripcion }}</p>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="badge bg-primary">${{ servicio.precio }}</span>
                                                    <span class="badge bg-secondary">{{ servicio.duracion }} min</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Paquetes -->
                    <div class="mb-4">
                        <h5 class="mb-3">Paquetes</h5>
                        <div class="row" id="paquetes-container">
                            {% for paquete in paquetes %}
                            <div class="col-md-6 mb-3">
                                <div class="card paquete-card h-100" data-id="{{ paquete.id_paquete }}" data-tipo="paquete" data-precio="{{ paquete.precio }}" data-duracion="{{ paquete.duracion_total }}">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input paquete-checkbox" type="radio" name="paquete" 
                                                   id="paquete-{{ paquete.id_paquete }}">
                                            <label class="form-check-label w-100" for="paquete-{{ paquete.id_paquete }}">
                                                <h6 class="card-title">{{ paquete.nombre }}</h6>
                                                <p class="card-text text-muted small">{{ paquete.descripcion }}</p>
                                                <p class="card-text small"><strong>Incluye:</strong> {{ paquete.servicios_incluidos }}</p>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="badge bg-success">${{ paquete.precio }}</span>
                                                    <span class="badge bg-secondary">{{ paquete.duracion_total }} min</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Resumen -->
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6>Resumen de Selección</h6>
                            <div id="resumen-servicios">
                                <p class="text-muted">No hay servicios seleccionados</p>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <strong>Total: $<span id="total-precio">0</span></strong>
                                <strong>Duración: <span id="total-duracion">0</span> min</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Navegación -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="/citas/nueva-cita" class="btn btn-secondary">
                            <i class="fa fa-arrow-left me-2"></i>Anterior
                        </a>
                        <button id="btn-continuar" class="btn btn-primary" disabled>
                            Continuar <i class="fa fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let serviciosSeleccionados = [];

function actualizarResumen() {
    const resumen = document.getElementById('resumen-servicios');
    const totalPrecio = document.getElementById('total-precio');
    const totalDuracion = document.getElementById('total-duracion');
    const btnContinuar = document.getElementById('btn-continuar');

    if (serviciosSeleccionados.length === 0) {
        resumen.innerHTML = '<p class="text-muted">No hay servicios seleccionados</p>';
        totalPrecio.textContent = '0';
        totalDuracion.textContent = '0';
        btnContinuar.disabled = true;
        return;
    }

    let html = '';
    let total = 0;
    let duracionTotal = 0;

    serviciosSeleccionados.forEach(servicio => {
        html += `<div class="d-flex justify-content-between">
            <span>${servicio.nombre}</span>
            <span>$${servicio.precio} - ${servicio.duracion} min</span>
        </div>`;
        total += parseFloat(servicio.precio);
        duracionTotal += parseInt(servicio.duracion);
    });

    resumen.innerHTML = html;
    totalPrecio.textContent = total.toFixed(2);
    totalDuracion.textContent = duracionTotal;
    btnContinuar.disabled = false;
}

// Event listeners para checkboxes
document.querySelectorAll('.servicio-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const card = this.closest('.servicio-card');
        const id = card.dataset.id;
        const tipo = card.dataset.tipo;
        const precio = parseFloat(card.dataset.precio);
        const duracion = parseInt(card.dataset.duracion);
        const nombre = card.querySelector('.card-title').textContent;

        if (this.checked) {
            serviciosSeleccionados.push({
                id: id,
                tipo: tipo,
                nombre: nombre,
                precio: precio,
                duracion: duracion
            });
        } else {
            serviciosSeleccionados = serviciosSeleccionados.filter(s => !(s.id === id && s.tipo === tipo));
        }
        actualizarResumen();
    });
});

// Event listeners para paquetes (radio buttons)
document.querySelectorAll('.paquete-checkbox').forEach(radio => {
    radio.addEventListener('change', function() {
        if (this.checked) {
            const card = this.closest('.paquete-card');
            const id = card.dataset.id;
            const tipo = card.dataset.tipo;
            const precio = parseFloat(card.dataset.precio);
            const duracion = parseInt(card.dataset.duracion);
            const nombre = card.querySelector('.card-title').textContent;

            // Limpiar servicios individuales cuando se selecciona un paquete
            serviciosSeleccionados = serviciosSeleccionados.filter(s => s.tipo !== 'servicio');
            document.querySelectorAll('.servicio-checkbox').forEach(cb => cb.checked = false);

            serviciosSeleccionados.push({
                id: id,
                tipo: tipo,
                nombre: nombre,
                precio: precio,
                duracion: duracion
            });
        } else {
            serviciosSeleccionados = serviciosSeleccionados.filter(s => s.tipo !== 'paquete');
        }
        actualizarResumen();
    });
});

// Continuar al siguiente paso
document.getElementById('btn-continuar').addEventListener('click', async function() {
    if (serviciosSeleccionados.length === 0) {
        alert('Por favor selecciona al menos un servicio o paquete');
        return;
    }

    try {
        const response = await fetch('/citas/guardar-servicios', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                servicios: serviciosSeleccionados
            })
        });

        const data = await response.json();
        
        if (data.message === "OK") {
            window.location.href = '/citas/seleccionar-fecha';
        } else {
            alert('Error al guardar los servicios: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar los servicios');
    }
});
</script>

<style>
.steps {
    display: flex;
    justify-content: space-between;
    position: relative;
}
.steps::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 0;
    right: 0;
    height: 2px;
    background-color: #e9ecef;
    z-index: 1;
}
.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
}
.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 8px;
    border: 3px solid white;
}
.step.completed .step-number {
    background-color: #28a745;
    color: white;
}
.step.active .step-number {
    background-color: #007bff;
    color: white;
}
.step-label {
    font-size: 0.875rem;
    color: #6c757d;
}
.step.active .step-label {
    color: #007bff;
    font-weight: bold;
}
.servicio-card:hover, .paquete-card:hover {
    border-color: #007bff;
    cursor: pointer;
}
</style>
{% endblock %}