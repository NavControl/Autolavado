{% extends 'admin/base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fa fa-edit me-2"></i>Editar Paquete: {{ paquete.nombre }}</h2>
        <a href="/services/paquetes" class="btn btn-outline-secondary">
            <i class="fa fa-arrow-left me-2"></i>Volver a Paquetes
        </a>
    </div>

    <div class="row">
        <!-- Formulario del Paquete -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-white">
                    <h5 class="card-title mb-0">Editar Información del Paquete</h5>
                </div>
                <div class="card-body">
                    <form id="formPaquete">
                        <input type="hidden" id="idPaquete" value="{{ paquete.id_paquete }}">
                        <div class="mb-3">
                            <label for="nombrePaquete" class="form-label">Nombre del Paquete</label>
                            <input type="text" class="form-control" id="nombrePaquete" value="{{ paquete.nombre }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="descripcionPaquete" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcionPaquete" rows="3">{{ paquete.descripcion or '' }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="precioPaquete" class="form-label">Precio del Paquete ($)</label>
                            <input type="number" step="0.01" class="form-control" id="precioPaquete" value="{{ paquete.precio }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Servicios seleccionados:</span>
                                <span id="contadorServicios" class="badge bg-primary">{{ servicios_seleccionados|length }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Duración total:</span>
                                <span id="duracionTotal" class="badge bg-info">{{ paquete.duracion_total }} min</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Precio individual:</span>
                                <span id="precioIndividual" class="badge bg-secondary">$0.00</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span><strong>Ahorro:</strong></span>
                                <span id="ahorro" class="badge bg-success">$0.00</span>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-warning w-100" onclick="actualizarPaquete()">
                            <i class="fa fa-save me-2"></i>Actualizar Paquete
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Lista de Servicios Disponibles -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Selecciona los Servicios para el Paquete</h5>
                </div>
                <div class="card-body">
                    {% if servicios %}
                    <div class="row" id="listaServicios">
                        {% for servicio in servicios %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card servicio-card h-100" data-servicio-id="{{ servicio.id_servicio }}">
                                <div class="card-body">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input servicio-checkbox" 
                                               type="checkbox" 
                                               value="{{ servicio.id_servicio }}"
                                               id="servicio{{ servicio.id_servicio }}"
                                               data-precio="{{ servicio.precio }}"
                                               data-duracion="{{ servicio.duracion }}"
                                               {% if servicio.id_servicio in servicios_seleccionados %}checked{% endif %}
                                               onchange="actualizarResumen()">
                                        <label class="form-check-label fw-bold" for="servicio{{ servicio.id_servicio }}">
                                            {{ servicio.nombre }}
                                        </label>
                                    </div>
                                    <p class="card-text small text-muted mb-2">{{ servicio.descripcion or 'Sin descripción' }}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-success fw-bold">${{ servicio.precio }}</span>
                                        <span class="text-muted small">{{ servicio.duracion }} min</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fa fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                        <p class="text-muted">No hay servicios disponibles.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Array para almacenar los servicios seleccionados (inicialmente los que ya están en el paquete)
let serviciosSeleccionados = {{ servicios_seleccionados | tojson }};

// Función para actualizar el resumen
function actualizarResumen() {
    const checkboxes = document.querySelectorAll('.servicio-checkbox:checked');
    serviciosSeleccionados = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    // Calcular totales
    let precioTotal = 0;
    let duracionTotal = 0;
    
    checkboxes.forEach(cb => {
        precioTotal += parseFloat(cb.dataset.precio);
        duracionTotal += parseInt(cb.dataset.duracion);
    });
    
    // Actualizar UI
    document.getElementById('contadorServicios').textContent = serviciosSeleccionados.length;
    document.getElementById('duracionTotal').textContent = duracionTotal + ' min';
    document.getElementById('precioIndividual').textContent = '$' + precioTotal.toFixed(2);
    
    // Calcular ahorro cuando se ingresa el precio del paquete
    const precioPaquete = parseFloat(document.getElementById('precioPaquete').value) || 0;
    const ahorro = precioTotal - precioPaquete;
    document.getElementById('ahorro').textContent = '$' + ahorro.toFixed(2);
    
    if (ahorro > 0) {
        document.getElementById('ahorro').className = 'badge bg-success';
    } else if (ahorro < 0) {
        document.getElementById('ahorro').className = 'badge bg-danger';
    } else {
        document.getElementById('ahorro').className = 'badge bg-secondary';
    }
}

// Función para actualizar el paquete
async function actualizarPaquete() {
    const idPaquete = document.getElementById('idPaquete').value;
    const nombre = document.getElementById('nombrePaquete').value;
    const descripcion = document.getElementById('descripcionPaquete').value;
    const precio = document.getElementById('precioPaquete').value;
    
    if (!nombre || !precio) {
        alert('Por favor, completa el nombre y precio del paquete');
        return;
    }
    
    if (serviciosSeleccionados.length === 0) {
        alert('Selecciona al menos un servicio para el paquete');
        return;
    }
    
    try {
        const response = await fetch('/services/procesar-edicion-paquete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                id_paquete: parseInt(idPaquete),
                nombre: nombre,
                descripcion: descripcion,
                precio: parseFloat(precio),
                servicios: serviciosSeleccionados
            })
        });
        
        const data = await response.json();
        
        if (data.message === "OK") {
            alert('Paquete actualizado correctamente');
            window.location.href = '/services/paquetes';
        } else {
            alert('Error al actualizar el paquete: ' + (data.error || ''));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al actualizar el paquete');
    }
}

// Inicializar el resumen al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    actualizarResumen();
});

// Actualizar ahorro cuando cambia el precio del paquete
document.getElementById('precioPaquete').addEventListener('input', actualizarResumen);
</script>

<style>
.servicio-card {
    transition: all 0.3s;
    cursor: pointer;
}
.servicio-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.servicio-checkbox:checked + label {
    color: #198754;
    font-weight: bold;
}
</style>
{% endblock %}